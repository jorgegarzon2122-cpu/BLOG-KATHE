<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Kathe - Corregido</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background: #f7f1e9; }
    .container{ max-width:900px; margin:40px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    h1{text-align:center;color:#8a3f61}
    label{font-weight:600; display:block; margin-top:10px}
    input, textarea{width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ddd}
    button{margin-top:12px; padding:10px 14px; background:#ff7f9c; color:#fff; border:none; border-radius:8px; cursor:pointer}
    .post{background:#fff9f9; padding:14px; margin-top:16px; border-radius:10px; border:1px solid #f0d7df}
    .post-title{font-weight:700; color:#8a3f61}
    .post button{background:#d35c9b; padding:6px 10px; font-size:13px; border-radius:8px; margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Blog Kathe</h1>

    <label for="titleInput">Título</label>
    <input id="titleInput" placeholder="Título del post..." />

    <label for="contentInput">Contenido</label>
    <textarea id="contentInput" rows="5" placeholder="Escribe algo..."></textarea>

    <button id="publishBtn">Publicar</button>

    <h2 style="margin-top:18px">Entradas</h2>
    <div id="postsContainer"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Config Firebase (tuya)
    const firebaseConfig = {
      apiKey: "AIzaSyClNq5xfMuRpegRKntdtQeFFa-GyPnsUAc",
      authDomain: "blog-kathe.firebaseapp.com",
      projectId: "blog-kathe",
      storageBucket: "blog-kathe.firebasestorage.app",
      messagingSenderId: "250193338842",
      appId: "1:250193338842:web:e140bdb9c897944fcfe0e3",
      measurementId: "G-2MSFW2C966"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const postsCol = collection(db, "posts");

    const titleInput = document.getElementById("titleInput");
    const contentInput = document.getElementById("contentInput");
    const publishBtn = document.getElementById("publishBtn");
    const postsContainer = document.getElementById("postsContainer");

    // escape básico para texto
    function escapeHtml(text){
      if (!text) return "";
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    async function loadPosts(){
      postsContainer.innerHTML = ""; // limpiar
      try {
        const snap = await getDocs(postsCol);
        // recorrer en orden inverso para mostrar el más reciente arriba
        const docs = [];
        snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
        docs.reverse();
        for (const d of docs){
          renderPost(d);
        }
      } catch (err){
        console.error("Error cargando posts:", err);
        postsContainer.textContent = "Error al cargar las entradas. Revisa la consola.";
      }
    }

    function renderPost(post){
      const card = document.createElement("div");
      card.className = "post";

      const titleEl = document.createElement("div");
      titleEl.className = "post-title";
      titleEl.textContent = post.title || "(sin título)";

      const dateEl = document.createElement("div");
      dateEl.style.fontSize = "12px";
      dateEl.style.color = "#6b6b6b";
      dateEl.textContent = post.date || post.createdAt || "";

      const contentEl = document.createElement("div");
      // Mantener saltos de línea: creamos texto y luego sustituimos '\n' por <br>
      const paragraphs = (post.content || "").split("\n");
      paragraphs.forEach((p, i) => {
        const span = document.createElement("span");
        span.textContent = p;
        contentEl.appendChild(span);
        if (i < paragraphs.length - 1) contentEl.appendChild(document.createElement("br"));
      });

      const actions = document.createElement("div");
      actions.style.marginTop = "10px";

      const delBtn = document.createElement("button");
      delBtn.textContent = "Eliminar";
      delBtn.addEventListener("click", async () => {
        if (!confirm("¿Eliminar esta entrada?")) return;
        try {
          await deleteDoc(doc(db, "posts", post.id));
          loadPosts();
        } catch (err) {
          console.error("Error eliminando:", err);
          alert("No se pudo eliminar. Revisa la consola.");
        }
      });

      actions.appendChild(delBtn);

      card.appendChild(titleEl);
      card.appendChild(dateEl);
      card.appendChild(contentEl);
      card.appendChild(actions);

      postsContainer.appendChild(card);
    }

    publishBtn.addEventListener("click", async () => {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      if (!title || !content) {
        alert("Título y contenido son obligatorios.");
        return;
      }
      try{
        await addDoc(postsCol, {
          title,
          content,
          createdAt: new Date().toLocaleString(),
          date: new Date().toLocaleString()
        });
        titleInput.value = "";
        contentInput.value = "";
        loadPosts();
      } catch (err){
        console.error("Error publicando:", err);
        alert("No se pudo publicar. Revisa la consola.");
      }
    });

    // carga inicial
    loadPosts();
  </script>
</body>
</html>
